<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSEN</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    />

    <!-- Leaflet CSS -->

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://rawgit.com/pointhi/leaflet-color-markers/master/leaflet.markercluster.2.0.0.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://rawgit.com/pointhi/leaflet-color-markers/master/leaflet.markercluster.2.0.0.min.js"></script>

    <style>
      #map {
        height: 400px;
        width: 100%;
        margin-top: 1rem;
      }
      .custom-pin {
        margin: 0;
      }
      .custom-pin svg {
        display: none;
      } /* Hide any SVG junk */
    </style>
  </head>
  <body class="light-mode">
    <div class="container">
      <header>
        <img src="csen-bw.png" />

        <nav>
          <div class="tabs">
            <button class="tab-btn active" data-tab="calendar">Calendar</button>
            <button class="tab-btn" data-tab="discuss">Discuss</button>
            <button class="tab-btn" data-tab="resources">Resources</button>
          </div>
        </nav>
      </header>

      <main>
        <div class="tab-content active" id="calendar">
          <div class="calendar-layout">
            <div class="calendar-container">
              <h3>NE Scotland Data & Tech Events Community Calendar</h3>
              <div
                data-tockify-component="mini"
                data-tockify-calendar="aberdeentechdata"
              ></div>
              <br />
              <p>
                Submit an event
                <a
                  href="https://tockify.com/tkf2/submitEvent/a94ef85d185442c19928f9e419b504f9"
                  >here</a
                >
              </p>
            </div>

            <div class="calendar-description">
              <h3>Community Institutions Map</h3>
              <p>
                Add your details
                <a
                  href="https://docs.google.com/forms/d/e/1FAIpQLScuwEBwKYQTLRk1oTnsr4O6nM-4ZAW-S5BtTPqO116tccPQkw/viewform?usp=publish-editor"
                  >here</a
                >
              </p>
              <div id="map"></div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="resources">
          <h2>Community Resources</h2>
          <p>You'll be redirected to our resource site shortly...</p>
          <div class="redirect-message">
            <p>
              If you're not redirected automatically, click the button below:
            </p>
            <a href="https://www.csteach.uk" class="cta-button" target="_self"
              >Go to Resources</a
            >
          </div>
        </div>

        <div class="tab-content" id="discuss">
          <h2>Join the Discussion</h2>
          <p>You'll be redirected to our community forum shortly...</p>
          <div class="redirect-message">
            <p>
              If you're not redirected automatically, click the button below:
            </p>
            <a
              href="https://teams.live.com/l/community/FDAa76RQyErK4_U6QI"
              class="cta-button"
              target="_self"
              >Go to Forum</a
            >
          </div>
        </div>

        <div class="tab-content" id="subscribe">
          <div class="redirect-message">
            <p>
              If you're not redirected automatically, click the button below:
            </p>
            <a
              href="https://csenabz.substack.com/subscribe"
              class="cta-button"
              target="_self"
              >Subscribe on Substack</a
            >
          </div>
        </div>
      </main>

      <footer>
        <p>Â© 2026 csteach.uk</p>
      </footer>
    </div>

    <script
      data-cfasync="false"
      data-tockify-script="embed"
      src="https://public.tockify.com/browser/embed.js"
    ></script>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const mapEl = document.getElementById("map");
        if (!mapEl) return;

        //const map = L.map("map").setView([57.15, -2.09], 7); // NE Scotland-ish
        const map = L.map("map").setView([57.23, -2.61], 8); // Aberdeenshire center, zoomed in

        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);

        // Layer groups by type
        const primaryGroup = L.layerGroup();
        const secondaryGroup = L.layerGroup();
        const specialGroup = L.layerGroup();
        const independentGroup = L.layerGroup();

        fetch("data/institutions.json")
          .then((response) => response.json())
          .then((institutions) => {
            const typeToRgb = {
              Primary: "#4A90E2", // Blue
              PrimaryNC: "#cee2f7", // light blue
              Secondary: "#E94B3C", // Red
              SecondaryNC: "#f9d0cd", // light red
              Special: "#F7CA18", // Gold
              SpecialNC: "#fdf3c9", // light gold
              Independent: "#A020F0", // Purple
              IndependentNC: "#e9cbfb", // light purple
            };

            const getColorIcon = (type) => {
              const color = typeToRgb[type] || "#808080";
              // Classic pin SVG path (from Leaflet defaults, optimized)
              const svgPin = `<svg xmlns='http://www.w3.org/2000/svg' width='25' height='41' viewBox='0 0 25 41'>
                <path fill='${color}' stroke='rgba(255,255,255,0.9)' stroke-width='1.5' stroke-linejoin='round' d='M12.5 0C5.71 0 0 5.71 0 12.5c0 8.1 12.5 30.5 12.5 30.5S25 20.6 25 12.5C25 5.71 19.29 0 12.5 0z' opacity='0.95'/>
                <circle fill='white' cx='12.5' cy='12.5' r='6' opacity='0.9'/>
              </svg>`;

              return L.icon({
                iconUrl: `data:image/svg+xml;base64,${btoa(svgPin)}`, // Encode SVG as data URI
                shadowUrl:
                  "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
              });
            };

            institutions.forEach((inst) => {
              if (
                typeof inst.Latitude !== "number" ||
                typeof inst.Longitude !== "number"
              )
                return;

              const contactsHtml =
                Array.isArray(inst.contacts) && inst.contacts.length
                  ? inst.contacts.map((c) => `ðŸ’» ${c}`).join("<br>")
                  : "ðŸ’» <i>no CS/ICT teacher</i>";

              const popupHtml = `
                    ${
                      inst.Website
                        ? `<a href="${inst.Website}" target="_blank"><strong>${inst.SchoolName}</strong></a>`
                        : `<strong>${inst.SchoolName}</strong>`
                    }
                           &nbsp;&nbsp;[${inst.SeedCode}]
                    <br>${inst.PostCode}, ${inst.LAName} (${inst.SchoolType})
                    <br>${contactsHtml}
                    <br>${inst.courses || ""}
                  `;
              const thisSchoolType =
                Array.isArray(inst.contacts) && inst.contacts.length
                  ? inst.SchoolType
                  : inst.SchoolType + "NC";
              const marker = L.marker([inst.Latitude, inst.Longitude], {
                icon: getColorIcon(thisSchoolType),
              }).bindPopup(popupHtml);

              // Add to correct group
              switch (inst.SchoolType) {
                case "Primary":
                  primaryGroup.addLayer(marker);
                  break;
                case "Secondary":
                  secondaryGroup.addLayer(marker);
                  break;
                case "Special":
                  specialGroup.addLayer(marker);
                  break;
                case "Independent":
                  independentGroup.addLayer(marker);
                  break;
              }
            });

            // Add groups to map (all visible initially)
            primaryGroup.addTo(map);
            secondaryGroup.addTo(map);
            specialGroup.addTo(map);
            independentGroup.addTo(map);

            // Add filter control (checkboxes)
            L.control
              .layers(null, {
                "Primary Schools": primaryGroup,
                "Secondary Schools": secondaryGroup,
                "Special Schools": specialGroup,
                "Independent Schools": independentGroup,
              })
              .addTo(map);
          })
          .catch((err) => console.error("Error loading JSON", err));
      });
    </script>

    <script src="script.js"></script>
  </body>
</html>
